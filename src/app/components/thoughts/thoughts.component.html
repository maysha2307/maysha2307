<div id="thoughts-section" class="section-content">
  <div class="thoughts-wrapper">
    <!-- Header -->
    <div class="thoughts-header">
      <div class="header-icon"><span class="feather-emoji">ðŸª¶</span></div>
      <h2>Thoughts</h2>
      <p class="subtitle">spill the feelings, memories, and little notes to each other.</p>
    </div>

    <!-- Notes Grid -->
    <div class="notes-grid">
    <!-- Note Card -->
    <div
      class="note"
      *ngFor="let note of thoughts$ | async; trackBy: trackById"
      [class.editing]="isEditing(note.id)"
      [class.active]="activeNoteId === note.id"
      (touchstart)="onNoteTouchStart($event, note.id)"
      (touchend)="onNoteTouchEnd($event)"
      (mousedown)="onNoteTouchStart($event, note.id)"
      (mouseup)="onNoteTouchEnd($event)"
      [style.transition]="'box-shadow 0.2s, transform 0.2s'"
    >

      <!-- Note body -->
      <div
        class="note-paper"
        [class.editing]="isEditing(note.id)"
      >
        <button class="note-heart-btn" [class.liked]="note.liked" (click)="toggleHeart(note, $event)" (pointerdown)="$event.stopPropagation()" tabindex="0" aria-label="Like this thought">
          <span class="note-heart" [class.liked]="note.liked">&#10084;</span>
        </button>
        <pre *ngIf="!isEditing(note.id)" style="margin:0;background:none;border:none;font-family:'Dancing Script',cursive;font-size:1.18rem;line-height:1.7;text-indent:1.2em;white-space:pre-wrap;word-break:break-word;">{{note.text}}</pre>
        <textarea *ngIf="isEditing(note.id)"
          class="note-textarea"
          [(ngModel)]="draftText[note.id!]"
          rows="5"
          style="width:100%;font-family:'Dancing Script',cursive;font-size:1.18rem;background:#fffbe9;border:none;outline:2px dashed rgba(236,64,122,0.7);border-radius:10px;resize:vertical;box-sizing:border-box;"
        ></textarea>
      </div>

      <!-- Actions row -->
      <div class="note-actions">
        <button class="icon-btn" title="Edit" (click)="startEdit(note)">
          <span class="material-icons">edit</span>
        </button>
        <button *ngIf="!isEditing(note.id)" class="icon-btn danger" title="Delete" (click)="deleteNote(note)">
          <span class="material-icons">delete</span>
        </button>
        <button *ngIf="isEditing(note.id)" class="icon-btn cancel" title="Cancel" (click)="cancelEdit()">
          <span class="material-icons">cancel</span>
        </button>
        <button class="icon-btn" title="Reply" (click)="toggleReply(note)" *ngIf="!isEditing(note.id)">
          <span class="material-icons">chat_bubble_outline</span>
        </button>
        <button *ngIf="isEditing(note.id)" class="icon-btn save" title="Save" (click)="saveEdit(note)">
          <span class="material-icons">check_circle</span>
        </button>
      </div>

      <!-- Reply -->
      <div class="reply-paper" *ngIf="isReplyOpen(note.id)">
        <div style="display: flex; align-items: flex-start;">
          <div style="flex: 1; margin-right: 12px;">
            <pre *ngIf="replyEditingId !== note.id" style="margin:0;background:none;border:none;font-family:'Dancing Script',cursive;font-size:1.05rem;line-height:1.6;white-space:pre-wrap;word-break:break-word;">{{getTrimmedReply(note)}}</pre>
            <textarea *ngIf="replyEditingId === note.id"
              class="reply-textarea"
              [(ngModel)]="draftReply[note.id!]"
              rows="3"
              style="width:100%;font-family:'Dancing Script',cursive;font-size:1.05rem;background:#fffbe9;border:none;outline:2px dashed rgba(236,64,122,0.7);border-radius:10px;resize:vertical;padding:8px 0px 8px 0px;box-sizing:border-box;"
            ></textarea>
          </div>
          <div class="reply-action-group">
            <button *ngIf="replyEditingId !== note.id" class="icon-btn" title="Edit reply" (click)="startReplyEdit(note)">
              <span class="material-icons">edit</span>
            </button>
            <button *ngIf="replyEditingId !== note.id" class="icon-btn danger" title="Delete reply" (click)="deleteReply(note)">
              <span class="material-icons">delete</span>
            </button>
            <button *ngIf="replyEditingId === note.id" class="icon-btn save" title="Save reply" (click)="saveReply(note)">
              <span class="material-icons">check_circle</span>
            </button>
            <button *ngIf="replyEditingId === note.id" class="icon-btn cancel" title="Cancel" (click)="cancelReplyEdit(note)">
              <span class="material-icons">cancel</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>



    <!-- Add Button at bottom of notes grid -->
    <div class="add-btn-row">
      <button class="add-btn" (click)="addNote()" [disabled]="creating()">ï¼‹</button>
    </div>

    <!-- shared dialog will render via DialogComponent -->
  </div>
</div>
